<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Question Coach Test Suite</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .test-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }

    .test-card:hover {
      transform: translateY(-2px);
    }

    .test-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .test-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 50%;
      font-weight: bold;
      font-size: 1.2rem;
      margin-right: 15px;
    }

    .test-title {
      flex: 1;
    }

    .test-title h2 {
      color: #1a202c;
      font-size: 1.5rem;
      margin-bottom: 5px;
    }

    .test-title p {
      color: #718096;
      font-size: 0.9rem;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-pending {
      background: #e2e8f0;
      color: #4a5568;
    }

    .status-running {
      background: #fef3c7;
      color: #92400e;
      animation: pulse 2s infinite;
    }

    .status-success {
      background: #d1fae5;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      color: #4a5568;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .input-group input,
    .input-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
      font-family: inherit;
    }

    .input-group input:focus,
    .input-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .input-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
      margin-left: 10px;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #cbd5e0;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .result-container {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
    }

    .result-success {
      background: #d1fae5;
      border-left: 4px solid #10b981;
      color: #065f46;
    }

    .result-error {
      background: #fee2e2;
      border-left: 4px solid #ef4444;
      color: #991b1b;
    }

    .result-info {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      color: #1e40af;
    }

    .result-header {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .json-view {
      white-space: pre-wrap;
      word-break: break-word;
    }

    .info-box {
      background: #eff6ff;
      border: 2px solid #bfdbfe;
      border-radius: 8px;
      padding: 12px;
      margin: 15px 0;
      font-size: 0.9rem;
      color: #1e40af;
    }

    .info-box strong {
      color: #1e3a8a;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .stat-item {
      background: #f8fafc;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #64748b;
      text-transform: uppercase;
      font-weight: 600;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #1e293b;
      margin-top: 5px;
    }

    .all-tests-btn {
      width: 100%;
      padding: 16px;
      font-size: 1.1rem;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü§ñ AI Question Coach</h1>
      <p>Complete Test Suite for AI Features</p>
    </div>

    <!-- Run All Tests Button -->
    <button class="btn all-tests-btn" onclick="runAllTests()" id="btn-all">
      ‚ñ∂Ô∏è Run All Tests
    </button>

    <!-- Test 1: Basic LLM Connection -->
    <div class="test-card">
      <div class="test-header">
        <div style="display: flex; align-items: center; flex: 1;">
          <div class="test-number">1</div>
          <div class="test-title">
            <h2>Basic LLM Connection</h2>
            <p>Verify that the LLM provider (Gemini/OpenAI/Anthropic) is configured and working</p>
          </div>
        </div>
        <span class="status-badge status-pending" id="status-1">Pending</span>
      </div>

      <div class="info-box">
        <strong>What this tests:</strong> API key validity, provider configuration, basic prompt/response cycle
      </div>

      <button class="btn" onclick="testBasicLLM()" id="btn-test1">
        Run Test 1
      </button>

      <div id="result-1"></div>
    </div>

    <!-- Test 2: Tier 1 Validation -->
    <div class="test-card">
      <div class="test-header">
        <div style="display: flex; align-items: center; flex: 1;">
          <div class="test-number">2</div>
          <div class="test-title">
            <h2>Tier 1: Rule-Based Validation</h2>
            <p>Test quick question quality checks (no AI, instant response)</p>
          </div>
        </div>
        <span class="status-badge status-pending" id="status-2">Pending</span>
      </div>

      <div class="info-box">
        <strong>What this tests:</strong> Xano connection, rate limiting, validation logic, session creation
      </div>

      <div class="input-group">
        <label for="test2-title">Question Title:</label>
        <input 
          type="text" 
          id="test2-title" 
          placeholder="Try: 'help' or 'How do I price my SaaS product for SMBs?'"
          value="help me"
        />
      </div>

      <button class="btn" onclick="testTier1()" id="btn-test2">
        Run Test 2
      </button>
      <button class="btn btn-secondary" onclick="fillGoodQuestion()">
        Try Good Question
      </button>

      <div id="result-2"></div>
    </div>

    <!-- Test 3: Tier 2 AI Coaching -->
    <div class="test-card">
      <div class="test-header">
        <div style="display: flex; align-items: center; flex: 1;">
          <div class="test-number">3</div>
          <div class="test-title">
            <h2>Tier 2: AI-Powered Coaching</h2>
            <p>Test AI analysis and clarifying questions generation</p>
          </div>
        </div>
        <span class="status-badge status-pending" id="status-3">Pending</span>
      </div>

      <div class="info-box">
        <strong>What this tests:</strong> LLM integration, prompt engineering, JSON parsing, context analysis
        <br><strong>Note:</strong> Requires Test 2 to run first (needs session ID)
      </div>

      <div class="input-group">
        <label for="test3-context">Additional Context (optional):</label>
        <textarea 
          id="test3-context" 
          placeholder="Add extra context about the question..."
        >I'm building a project management tool targeting teams of 10-50 people. Competitors charge $10-25/user/month.</textarea>
      </div>

      <button class="btn" onclick="testTier2()" id="btn-test3">
        Run Test 3
      </button>

      <div id="result-3"></div>
    </div>

    <!-- Test Summary -->
    <div class="test-card" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
      <h2 style="margin-bottom: 15px; color: #1e293b;">Test Summary</h2>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">Tests Run</div>
          <div class="stat-value" id="stats-run">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Passed</div>
          <div class="stat-value" style="color: #10b981;" id="stats-pass">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Failed</div>
          <div class="stat-value" style="color: #ef4444;" id="stats-fail">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Duration</div>
          <div class="stat-value" id="stats-time">0s</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let sessionId = null;
    let testStats = { run: 0, pass: 0, fail: 0 };
    let startTime = null;

    // Update stats display
    function updateStats() {
      document.getElementById('stats-run').textContent = testStats.run;
      document.getElementById('stats-pass').textContent = testStats.pass;
      document.getElementById('stats-fail').textContent = testStats.fail;
      
      if (startTime) {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        document.getElementById('stats-time').textContent = elapsed + 's';
      }
    }

    // Set test status
    function setStatus(testNum, status) {
      const badge = document.getElementById(`status-${testNum}`);
      badge.className = `status-badge status-${status}`;
      
      const statusText = {
        pending: 'Pending',
        running: 'Running...',
        success: '‚úÖ Passed',
        error: '‚ùå Failed'
      };
      
      badge.textContent = statusText[status] || status;
    }

    // Show result
    function showResult(testNum, success, title, content) {
      const resultDiv = document.getElementById(`result-${testNum}`);
      const className = success ? 'result-success' : 'result-error';
      
      resultDiv.className = `result-container ${className}`;
      resultDiv.innerHTML = `
        <div class="result-header">${title}</div>
        <div class="json-view">${content}</div>
      `;
      
      setStatus(testNum, success ? 'success' : 'error');
      
      testStats.run++;
      if (success) testStats.pass++;
      else testStats.fail++;
      updateStats();
    }

    // Test 1: Basic LLM
    async function testBasicLLM() {
      const btn = document.getElementById('btn-test1');
      btn.disabled = true;
      btn.innerHTML = 'Running Test... <span class="spinner"></span>';
      setStatus(1, 'running');

      try {
        const response = await fetch('/api/test-llm');
        const data = await response.json();

        if (data.success) {
          showResult(1, true, '‚úÖ LLM Connection Successful', 
            `Provider: ${data.provider}\n\nResponse:\n${JSON.stringify(data.result, null, 2)}\n\n${data.note}`
          );
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        showResult(1, false, '‚ùå LLM Connection Failed', 
          `Error: ${error.message}\n\nTroubleshooting:\n- Check if LLM_PROVIDER env var is set\n- Verify API key is correct\n- Check Vercel function logs`
        );
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Run Test 1';
      }
    }

    // Test 2: Tier 1 Validation
    async function testTier1() {
      const btn = document.getElementById('btn-test2');
      const title = document.getElementById('test2-title').value.trim();

      if (!title) {
        alert('Please enter a question title');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = 'Running Test... <span class="spinner"></span>';
      setStatus(2, 'running');

      try {
        const response = await fetch('/api/ai/coach/quick-validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: title,
            fingerprint: 'test_fp_' + Date.now(),
            expertId: 'test_expert_123'
          })
        });

        const data = await response.json();

        if (response.ok) {
          sessionId = data.sessionId;
          
          const feedbackText = data.feedback.length > 0 
            ? data.feedback.map(f => `  ‚Ä¢ ${f.message} (${f.severity})`).join('\n')
            : '  No issues found!';

          showResult(2, true, '‚úÖ Tier 1 Validation Complete',
            `Session ID: ${data.sessionId}\n\nValidation Results:\n  Clarity Score: ${data.validation.clarityScore}/100\n  Word Count: ${data.validation.wordCount}\n  Has Question: ${data.validation.hasQuestion}\n  Too Short: ${data.validation.isTooShort}\n  Too Vague: ${data.validation.hasVagueness}\n\nFeedback:\n${feedbackText}\n\n‚ú® Session saved! Ready for Test 3`
          );
        } else {
          throw new Error(data.error || 'Validation failed');
        }
      } catch (error) {
        showResult(2, false, '‚ùå Tier 1 Validation Failed',
          `Error: ${error.message}\n\nTroubleshooting:\n- Check if /api/ai/coach/quick-validate exists\n- Verify Xano connection\n- Check rate limiting logic`
        );
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Run Test 2';
      }
    }

    // Test 3: Tier 2 Coaching
    async function testTier2() {
      const btn = document.getElementById('btn-test3');
      const context = document.getElementById('test3-context').value.trim();

      if (!sessionId) {
        showResult(3, false, '‚ùå Cannot Run Test 3',
          'Session ID missing!\n\nPlease run Test 2 first to create a session.\n\nThe session ID is needed to track the coaching flow.'
        );
        return;
      }

      btn.disabled = true;
      btn.innerHTML = 'Running Test... <span class="spinner"></span>';
      setStatus(3, 'running');

      try {
        const response = await fetch('/api/ai/coach/analyze-and-guide', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId: sessionId,
            expertProfile: {
              name: 'Test Expert',
              specialty: 'SaaS Pricing & Strategy',
              id: 'test_expert_123'
            },
            questionContext: context ? { text: context } : null
          })
        });

        const data = await response.json();

        if (response.ok) {
          const clarificationsText = data.clarifications
            .map((c, i) => `  ${i + 1}. ${c.question}\n     Why: ${c.why}\n     Optional: ${c.optional}`)
            .join('\n\n');

          const attachmentsText = data.attachmentSuggestions?.length > 0
            ? data.attachmentSuggestions.map(s => `  ‚Ä¢ ${s}`).join('\n')
            : '  None suggested';

          showResult(3, true, '‚úÖ Tier 2 AI Coaching Complete',
            `Analysis:\n  Summary: ${data.analysis.summary}\n  Clarity: ${data.analysis.clarity}/100\n\nMissing Context:\n${data.analysis.missingContext.map(m => `  ‚Ä¢ ${m}`).join('\n')}\n\nClarifying Questions:\n${clarificationsText}\n\nAttachment Suggestions:\n${attachmentsText}\n\nüéâ All tests passed!`
          );
        } else {
          throw new Error(data.error || 'Coaching failed');
        }
      } catch (error) {
        showResult(3, false, '‚ùå Tier 2 Coaching Failed',
          `Error: ${error.message}\n\nTroubleshooting:\n- Check if LLM provider is working (Test 1)\n- Verify session exists in Xano\n- Check LLM prompt format\n- Review Vercel function logs`
        );
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Run Test 3';
      }
    }

    // Helper: Fill good question
    function fillGoodQuestion() {
      document.getElementById('test2-title').value = 
        'How should I price my SaaS project management tool for teams of 10-50 people?';
    }

    // Run all tests sequentially
    async function runAllTests() {
      const btn = document.getElementById('btn-all');
      btn.disabled = true;
      btn.innerHTML = 'Running All Tests... <span class="spinner"></span>';
      
      // Reset stats
      testStats = { run: 0, pass: 0, fail: 0 };
      startTime = Date.now();
      updateStats();

      // Fill good question for testing
      fillGoodQuestion();

      // Run tests sequentially
      await testBasicLLM();
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      await testTier1();
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      await testTier2();

      btn.disabled = false;
      btn.innerHTML = '‚ñ∂Ô∏è Run All Tests';
      
      // Show summary alert
      const allPassed = testStats.fail === 0;
      const message = allPassed 
        ? `üéâ All tests passed!\n\n${testStats.pass}/${testStats.run} tests successful`
        : `‚ö†Ô∏è Some tests failed\n\n${testStats.pass}/${testStats.run} passed, ${testStats.fail} failed`;
      
      setTimeout(() => alert(message), 500);
    }

    // Initialize
    updateStats();
  </script>
</body>
</html>